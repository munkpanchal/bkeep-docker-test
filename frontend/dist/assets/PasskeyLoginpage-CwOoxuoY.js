import{a as c,j as e}from"./react-core-0npe00lJ.js";import{u as C,L as i}from"./react-router-lgh_Y1WM.js";import{s as L}from"./webauthn-BZJNpIWw.js";import{z as f,x as p,F as j}from"./react-icons-B--SyvS1.js";import{g as u,i as w,c as I,d as D,B as x,A as n,s as o,e as F,r as b,f as H,l as R}from"./index-HjQGXCX9.js";import"./react-dom-CdyVvfHO.js";import"./vendor-CGKUqG9W.js";import"./react-query-BvwtvcJK.js";import"./ui-libs-CuSWTeap.js";import"./zustand-Ccm-5Iud.js";import"./axios-B9ygI19o.js";async function g(){const s={hasStoredUser:!1,storedEmail:null,webAuthnSupported:!1,isPlatformAuthenticatorAvailable:null,isHttps:window.location.protocol==="https:"||window.location.hostname==="localhost",userAgent:navigator.userAgent,issues:[],recommendations:[]},r=u();if(r?(s.hasStoredUser=!0,s.storedEmail=r.email):(s.issues.push("No stored user email found in localStorage"),s.recommendations.push("Log in with email and password first to store your email")),s.webAuthnSupported=w(),s.webAuthnSupported||(s.issues.push("WebAuthn is not supported in this browser"),s.recommendations.push("Use a modern browser like Chrome, Safari, Firefox, or Edge")),s.webAuthnSupported)try{s.isPlatformAuthenticatorAvailable=await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable(),s.isPlatformAuthenticatorAvailable||(s.issues.push("Platform authenticator (Touch ID, Face ID, Windows Hello) not available"),s.recommendations.push("Use a device with biometric authentication or a security key"))}catch(a){console.error("Error checking platform authenticator:",a)}return s.isHttps||(s.issues.push("Not using HTTPS - WebAuthn requires secure context"),s.recommendations.push("Use HTTPS in production (localhost is allowed for development)")),s}async function N(){console.group("ðŸ” Passkey Diagnostics");const s=await g();console.log("Stored User:",s.hasStoredUser?s.storedEmail:"None"),console.log("WebAuthn Supported:",s.webAuthnSupported),console.log("Platform Authenticator:",s.isPlatformAuthenticatorAvailable),console.log("HTTPS:",s.isHttps),console.log("User Agent:",s.userAgent),s.issues.length>0&&(console.group("âš ï¸ Issues Found"),s.issues.forEach((r,a)=>{console.warn(`${a+1}. ${r}`)}),console.groupEnd()),s.recommendations.length>0&&(console.group("ðŸ’¡ Recommendations"),s.recommendations.forEach((r,a)=>{console.info(`${a+1}. ${r}`)}),console.groupEnd()),s.issues.length===0&&console.log("âœ… All checks passed! Passkey login should work."),console.groupEnd()}async function O(s,r){try{const a=await fetch(`${r}/auth/passkey/login/options`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s})}),l=await a.json();if(!a.ok)return{success:!1,hasCredentials:!1,credentialCount:0,error:l.message||`HTTP ${a.status}`};const d=l.data?.allowCredentials?.length||0;return{success:!0,hasCredentials:d>0,credentialCount:d}}catch(a){return{success:!1,hasCredentials:!1,credentialCount:0,error:a instanceof Error?a.message:"Unknown error"}}}function W(){localStorage.removeItem("passkeyUser"),console.log("Passkey user data cleared from localStorage")}async function $(){const s=await g();return JSON.stringify(s,null,2)}typeof window<"u"&&(window.passkeyDebug={diagnose:g,log:N,clear:W,export:$,test:O});function M(){const[s,r]=c.useState(u()),[a,l]=c.useState(!1),[d,y]=c.useState(!1),[v,k]=c.useState(!0),S=C(),{mutateAsync:P}=I(),{mutateAsync:A}=D();c.useEffect(()=>{N().catch(console.error);const t=u();console.log("Stored passkey user:",t),t?r(t):console.warn("No stored passkey user found in localStorage");const m=w();console.log("WebAuthn supported:",m),k(m),new URLSearchParams(window.location.search).get("timeout")==="true"&&y(!0)},[]);const E=async()=>{if(!s){o("No passkey account found. Please sign in with email and password first to set up passkey login.");return}l(!0),console.log("Starting passkey authentication for:",s.email);try{console.log("Step 1: Requesting passkey login options...");const t=await P({email:s.email});if(!t?.data)throw console.error("No data in init response:",t),new Error("Failed to get passkey options from server");console.log("initResponse",t);const m=t.data.options;console.log("Step 2: Starting authentication with passkey...");const h=await L({optionsJSON:m});console.log("Step 3: Verifying credential with backend..."),await A({email:s.email,credential:h}),console.log("Authentication successful, updating stored user..."),F(s.email,h.id),r(u()),console.log("Passkey login completed successfully")}catch(t){console.error("Passkey authentication failed:",t),t instanceof Error&&t.message.includes("No passkeys found")?o(t.message):t instanceof DOMException?t.name==="NotAllowedError"?o("Authentication was cancelled or not allowed. Please try again."):t.name==="SecurityError"?o("Security error during authentication. Please ensure you are on a secure connection (HTTPS)."):t.name==="AbortError"?o("Authentication was aborted. Please try again."):t.name==="NotSupportedError"?o("Your device does not support this type of passkey."):t.name==="InvalidStateError"?o("Passkey is not registered on this device."):o(`Authentication error: ${t.message}`):t instanceof Error&&o(t.message||"Passkey authentication failed. Please try again.")}finally{l(!1)}},T=()=>{b(),r(null),S("/login")},U=()=>{b(),r(null),H("User ID removed")};return v?s?e.jsxs("div",{className:"space-y-6",children:[d&&e.jsxs("div",{className:"border border-blue-200 bg-blue-50 rounded-lg p-4 flex items-start gap-3",children:[e.jsx("div",{className:"shrink-0 mt-0.5",children:e.jsx("svg",{className:"w-5 h-5 text-blue-600",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Your session timed out."}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Sign in again to continue."})]}),e.jsx("button",{onClick:()=>y(!1),className:"shrink-0 text-blue-600 hover:text-blue-800",children:e.jsx(j,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"border border-primary-10 bg-gray-50 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"shrink-0 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center",children:e.jsx(p,{className:"w-5 h-5 text-gray-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-primary",children:s.email}),e.jsxs("p",{className:"text-xs text-primary-50 mt-1",children:["Last accessed ",s.lastAccessed," on this device with ",n]})]})]})}),e.jsxs("div",{className:"text-xs text-primary-50 leading-relaxed",children:["By signing in to access your ",n," Account, you agree to"," ",e.jsxs(i,{to:"/terms",className:"text-primary hover:underline",target:"_blank",children:[n," Terms"]}),". Our"," ",e.jsx(i,{to:"/privacy",className:"text-primary hover:underline",target:"_blank",children:"Privacy Policy"})," ","applies to your personal data. Standard call or SMS rates may apply."]}),e.jsxs(x,{type:"button",variant:"primary",className:"w-full normal-case",onClick:E,loading:a,disabled:a,children:[e.jsx(f,{className:"w-5 h-5"}),a?"Authenticating with passkey...":"Sign in with Passkey "]}),e.jsxs("div",{className:"pt-4 border-t border-primary-10",children:[e.jsx("p",{className:"text-sm font-medium text-primary mb-3",children:"Other actions"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:T,className:"w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-primary-10 bg-white hover:bg-primary-5 transition-colors text-left",children:[e.jsx("div",{className:"shrink-0 w-8 h-8 rounded-full bg-primary-10 flex items-center justify-center",children:e.jsx(p,{className:"w-4 h-4 text-primary"})}),e.jsx("span",{className:"text-sm text-primary-75",children:"Use a different account"})]}),e.jsxs("button",{onClick:U,className:"w-full flex items-center gap-3 px-4 py-3 rounded-lg border border-primary-10 bg-white hover:bg-primary-5 transition-colors text-left",children:[e.jsx("div",{className:"shrink-0 w-8 h-8 rounded-full bg-red-10 flex items-center justify-center",children:e.jsx(j,{className:"w-4 h-4 text-red-600"})}),e.jsx("span",{className:"text-sm text-primary-75",children:"Remove a user ID"})]})]})]}),e.jsx("div",{className:"pt-4 text-center",children:e.jsxs("p",{className:"text-sm text-primary-50",children:["New to ",n,"?"," ",e.jsx(i,{to:"/register",className:"text-primary font-medium hover:underline",children:"Create an account"})]})}),e.jsx("div",{className:"pt-4 text-center",children:e.jsxs("p",{className:"text-xs text-primary-40",children:["Invisible reCAPTCHA by Google"," ",e.jsx(i,{to:"https://policies.google.com/privacy",className:"text-primary hover:underline",target:"_blank",children:"Privacy Policy"}),", and"," ",e.jsx(i,{to:"https://policies.google.com/terms",className:"text-primary hover:underline",target:"_blank",children:"Terms of Use"}),"."]})})]}):e.jsxs("div",{className:"space-y-6 text-center py-8",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-primary-10 flex items-center justify-center",children:e.jsx(f,{className:"w-8 h-8 text-primary-50"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-primary mb-2",children:"No Passkey Account Found"}),e.jsx("p",{className:"text-sm text-primary-75 mb-4",children:"To use passkey login, you need to:"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-xl p-4 text-left",children:e.jsxs("ol",{className:"text-sm text-blue-900 space-y-2",children:[e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"font-semibold",children:"1."}),e.jsx("span",{children:"Sign in with your email and password"})]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"font-semibold",children:"2."}),e.jsx("span",{children:"Go to Settings â†’ Security"})]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"font-semibold",children:"3."}),e.jsx("span",{children:'Click "Passkey Management" and register a passkey'})]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"font-semibold",children:"4."}),e.jsx("span",{children:"Return here to use passkey login"})]})]})}),e.jsx(i,{to:"/login",children:e.jsxs(x,{variant:"primary",className:"w-full",children:[e.jsx(p,{className:"w-4 h-4"}),"Sign In with Email & Password"]})})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-sm text-red-600 mb-4",children:"Passkey authentication is not supported in this browser. Please use a modern browser or sign in with email and password."}),e.jsx(i,{to:"/login",children:e.jsx(x,{variant:"primary",children:"Go to Sign In"})})]})}const Z=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-white p-6",children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(i,{to:"/",className:"inline-block mb-6",children:e.jsx("img",{src:R,alt:n,className:"h-10 mx-auto"})}),e.jsxs("h1",{className:"text-2xl font-semibold text-primary",children:["Let's get you in to ",n]})]}),e.jsx("div",{className:"bg-white",children:e.jsx(M,{})}),e.jsx("div",{className:"mt-8 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-6 text-sm",children:[e.jsx(i,{to:"/legal",className:"text-primary hover:underline",children:"Legal"}),e.jsx(i,{to:"/privacy",className:"text-primary hover:underline",children:"Privacy"}),e.jsx(i,{to:"/security",className:"text-primary hover:underline",children:"Security"})]})})]})});export{Z as default};
