# Tax Management

## Overview

Tax Management allows users to configure and manage tax rates for their tenant. Taxes are used in transactions, invoices, and bills to calculate tax amounts. The system supports multiple tax types (normal, compound, withholding) and provides comprehensive tax management capabilities.

**Key Features:**
- **Tax Configuration** - Create and manage tax rates (0-100%)
- **Tax Types** - Support for normal, compound, and withholding taxes
- **Active/Inactive Status** - Enable/disable taxes without deletion
- **Statistics & Analytics** - View tax distribution and usage statistics
- **Soft Delete** - Restore deleted taxes if needed
- **Tax Calculations** - Built-in helper methods for tax calculations

**Use Cases:**
- Configure GST, VAT, Sales Tax, or other tax rates
- Manage different tax types for different jurisdictions
- Track tax usage across the system
- Enable/disable taxes based on business needs

---

## Flow

### Tax Creation Flow

```
1. User provides tax details (name, type, rate)
   ↓
2. System validates:
   - Name is required and unique (per tenant)
   - Rate is between 0-100%
   - Type is valid (normal, compound, withholding)
   ↓
3. Create tax record in tenant schema
   ↓
4. Set isActive = true (default)
   ↓
5. Return created tax
```

### Tax Update Flow

```
1. User provides updated tax details
   ↓
2. System validates:
   - Tax exists and belongs to tenant
   - Rate is between 0-100%
   - Type is valid
   ↓
3. Update tax fields
   ↓
4. Return updated tax
```

### Tax Enable/Disable Flow

```
1. User requests to enable/disable tax
   ↓
2. System validates:
   - Tax exists and belongs to tenant
   ↓
3. Update isActive status
   ↓
4. Return updated tax
```

### Tax Deletion Flow

```
1. User requests tax deletion
   ↓
2. System validates:
   - Tax exists and belongs to tenant
   ↓
3. Soft delete tax (set deleted_at)
   ↓
4. Tax is hidden from queries but preserved
   ↓
5. Return deleted tax
```

### Tax Calculation Flow

```
1. User has base amount and tax rate
   ↓
2. Calculate tax amount:
   taxAmount = (baseAmount × rate) / 100
   ↓
3. Calculate amount with tax:
   amountWithTax = baseAmount + taxAmount
   ↓
4. Or reverse calculate:
   baseAmount = amountWithTax / (1 + rate/100)
```

---

## Features Implemented

### ✅ Core Tax Management

- **Create Tax** - Create new tax configurations
- **List Taxes** - Paginated list with filtering and sorting
- **Get Tax** - Retrieve tax by ID
- **Update Tax** - Modify tax details
- **Delete Tax** - Soft delete tax (preserves data)
- **Restore Tax** - Restore soft-deleted tax

### ✅ Tax Status Management

- **Enable Tax** - Activate a tax (set isActive = true)
- **Disable Tax** - Deactivate a tax (set isActive = false)
- **Get Tax Status** - Retrieve status information for a specific tax

### ✅ Tax Analytics

- **Tax Statistics** - Aggregate statistics including:
  - Total tax count
  - Active/inactive counts
  - Counts by type (normal, compound, withholding)
  - Average tax rate
  - Recent taxes (last 5 created)

### ✅ Tax Types

- **Normal Tax** - Standard tax applied to base amount
- **Compound Tax** - Tax applied on top of other taxes
- **Withholding Tax** - Tax withheld at source

### ✅ Tax Calculations

- **Calculate Tax** - Calculate tax amount from base amount
- **Amount With Tax** - Get total amount including tax
- **Amount Without Tax** - Reverse calculate base amount from total

### ✅ Filtering & Search

- Filter by tax type (normal, compound, withholding)
- Filter by active/inactive status
- Search by tax name
- Sort by name, type, rate, isActive, createdAt, updatedAt

---

## Database Schema

### Taxes Table

The `taxes` table is stored in tenant-specific schemas:

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key (generated by BaseModel) |
| `tenant_id` | UUID | Reference to tenant (FK to public.tenants) |
| `name` | VARCHAR(255) | Tax name (e.g., "GST", "VAT", "Sales Tax") |
| `type` | VARCHAR(50) | Tax type: normal, compound, withholding |
| `rate` | DECIMAL(15,4) | Tax rate (0-100, e.g., 10.00 for 10%) |
| `is_active` | BOOLEAN | Whether tax is active (default: true) |
| `created_by` | UUID | User who created the tax (FK to public.users) |
| `created_at` | TIMESTAMP | Creation timestamp |
| `updated_at` | TIMESTAMP | Last update timestamp (auto-updated) |
| `deleted_at` | TIMESTAMP | Soft delete timestamp (nullable) |

**Indexes:**
- `idx_taxes_tenant_deleted` - `(tenant_id, deleted_at)`
- `idx_taxes_tenant_active` - `(tenant_id, is_active)`

**Constraints:**
- Primary key on `id`
- Foreign key: `tenant_id` → `public.tenants.id` (CASCADE)
- Foreign key: `created_by` → `public.users.id` (RESTRICT)

**Migration File:**
- `src/database/migrations/tenant/20251211051016_create_taxes_table.ts`

---

## API Endpoints

All tax endpoints are under `/api/v1/taxes` and require:
- Authentication (`authenticate` middleware)
- Tenant context (`setTenantContext` + `requireTenantContext` middleware)

### List Taxes

```http
GET /api/v1/taxes
```

**Query Parameters:**
- `page` (number, default: 1) - Page number
- `limit` (number, default: 20, max: 100) - Items per page
- `sort` (string, default: 'name') - Sort field: name, type, rate, isActive, createdAt, updatedAt
- `order` (string, default: 'asc') - Sort order: asc, desc
- `search` (string, optional) - Search by tax name
- `isActive` (boolean, optional) - Filter by active status
- `type` (string, optional) - Filter by type: normal, compound, withholding

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Taxes retrieved successfully",
  "data": {
    "items": [
      {
        "id": "tax-uuid",
        "name": "GST",
        "type": "normal",
        "rate": 10.0,
        "isActive": true,
        "createdAt": "2025-12-11T10:00:00Z",
        "updatedAt": "2025-12-11T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 10,
      "totalPages": 1
    }
  }
}
```

### Get Active Taxes

```http
GET /api/v1/taxes/active
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Taxes retrieved successfully",
  "data": [
    {
      "id": "tax-uuid",
      "name": "GST",
      "type": "normal",
      "rate": 10.0,
      "isActive": true
    }
  ]
}
```

### Get Tax Statistics

```http
GET /api/v1/taxes/stats
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax statistics retrieved successfully",
  "data": {
    "total": 10,
    "active": 8,
    "inactive": 2,
    "byType": {
      "normal": 7,
      "compound": 2,
      "withholding": 1
    },
    "averageRate": 12.5,
    "recentTaxes": [
      {
        "id": "tax-uuid",
        "name": "GST",
        "type": "normal",
        "rate": 10.0,
        "isActive": true,
        "createdAt": "2025-12-11T10:00:00Z"
      }
    ]
  }
}
```

### Get Tax by ID

```http
GET /api/v1/taxes/:id
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax retrieved successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "type": "normal",
    "rate": 10.0,
    "isActive": true,
    "createdAt": "2025-12-11T10:00:00Z",
    "updatedAt": "2025-12-11T10:00:00Z"
  }
}
```

### Get Tax Status

```http
GET /api/v1/taxes/:id/status
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax status retrieved successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "type": "normal",
    "rate": 10.0,
    "isActive": true,
    "createdAt": "2025-12-11T10:00:00Z",
    "updatedAt": "2025-12-11T10:00:00Z"
  }
}
```

### Create Tax

```http
POST /api/v1/taxes
Content-Type: application/json

{
  "name": "GST",
  "type": "normal",
  "rate": 10.0,
  "isActive": true
}
```

**Response:**
```json
{
  "success": true,
  "statusCode": 201,
  "message": "Tax created successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "type": "normal",
    "rate": 10.0,
    "isActive": true,
    "createdAt": "2025-12-11T10:00:00Z",
    "updatedAt": "2025-12-11T10:00:00Z"
  }
}
```

### Update Tax

```http
PUT /api/v1/taxes/:id
Content-Type: application/json

{
  "name": "Updated GST",
  "rate": 12.0,
  "isActive": false
}
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax updated successfully",
  "data": {
    "id": "tax-uuid",
    "name": "Updated GST",
    "type": "normal",
    "rate": 12.0,
    "isActive": false,
    "updatedAt": "2025-12-11T11:00:00Z"
  }
}
```

### Delete Tax

```http
DELETE /api/v1/taxes/:id
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax deleted successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "deletedAt": "2025-12-11T12:00:00Z"
  }
}
```

### Enable Tax

```http
PATCH /api/v1/taxes/:id/enable
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax enabled successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "isActive": true,
    "updatedAt": "2025-12-11T13:00:00Z"
  }
}
```

### Disable Tax

```http
PATCH /api/v1/taxes/:id/disable
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax disabled successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "isActive": false,
    "updatedAt": "2025-12-11T14:00:00Z"
  }
}
```

### Restore Tax

```http
PATCH /api/v1/taxes/:id/restore
```

**Response:**
```json
{
  "success": true,
  "statusCode": 200,
  "message": "Tax restored successfully",
  "data": {
    "id": "tax-uuid",
    "name": "GST",
    "isActive": true,
    "updatedAt": "2025-12-11T15:00:00Z"
  }
}
```

---

## Code Examples

### Using Tax Model

```typescript
import { Tax, TaxType } from '@models/Tax'

// Create a new tax
const tax = await Tax.query().insert({
  tenantId: 'tenant-uuid',
  name: 'GST',
  type: TaxType.NORMAL,
  rate: 10.0,
  isActive: true,
  createdBy: 'user-uuid',
})

// Calculate tax amount
const baseAmount = 1000
const taxAmount = tax.calculateTax(baseAmount) // Returns 100

// Get amount with tax
const totalAmount = tax.getAmountWithTax(baseAmount) // Returns 1100

// Get amount without tax (reverse calculation)
const baseFromTotal = tax.getAmountWithoutTax(1100) // Returns 1000

// Query active taxes
const activeTaxes = await Tax.query()
  .modify('notDeleted')
  .modify('byTenant', tenantId)
  .modify('active')
```

### Using Tax Queries

```typescript
import {
  findTaxes,
  findTaxById,
  createTax,
  updateTax,
  getTaxStatistics,
} from '@queries/tax.queries'

// List taxes with filters
const { taxes, total } = await findTaxes(tenantId, schemaName, {
  page: 1,
  limit: 20,
  sort: 'name',
  order: 'asc',
  isActive: true,
  type: TaxType.NORMAL,
})

// Get tax by ID
const tax = await findTaxById(tenantId, schemaName, taxId)

// Create tax
const newTax = await createTax(
  tenantId,
  schemaName,
  {
    name: 'GST',
    type: TaxType.NORMAL,
    rate: 10.0,
  },
  userId
)

// Get statistics
const stats = await getTaxStatistics(tenantId, schemaName)
```

### Frontend Integration Example

```typescript
// Fetch taxes
const response = await fetch('/api/v1/taxes?page=1&limit=20&isActive=true', {
  headers: {
    'Authorization': `Bearer ${accessToken}`,
  },
})
const { data } = await response.json()
const taxes = data.items

// Create tax
const newTax = await fetch('/api/v1/taxes', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    name: 'GST',
    type: 'normal',
    rate: 10.0,
    isActive: true,
  }),
})

// Get statistics
const statsResponse = await fetch('/api/v1/taxes/stats', {
  headers: {
    'Authorization': `Bearer ${accessToken}`,
  },
})
const stats = await statsResponse.json()
```

---

## Tax Types Explained

### Normal Tax

Standard tax applied directly to the base amount.

**Example:**
- Base amount: $100
- Tax rate: 10%
- Tax amount: $10
- Total: $110

**Use Cases:**
- GST (Goods and Services Tax)
- VAT (Value Added Tax)
- Sales Tax
- Provincial/State taxes

### Compound Tax

Tax applied on top of other taxes (tax on tax).

**Example:**
- Base amount: $100
- First tax (10%): $10
- Compound tax (5% on $110): $5.50
- Total: $115.50

**Use Cases:**
- Federal + Provincial taxes
- Multiple tax layers
- Cascading tax structures

### Withholding Tax

Tax withheld at source (typically for payments to vendors/contractors).

**Example:**
- Payment amount: $1000
- Withholding tax (15%): $150
- Net payment: $850

**Use Cases:**
- Contractor payments
- Vendor payments
- Tax withholding requirements
- 1099 preparation (US)

---

## Security Considerations

### Tenant Isolation

- All tax queries are filtered by `tenant_id`
- Users can only access taxes from their selected tenant
- Tenant context is enforced via middleware

### Data Validation

- Tax rate must be between 0-100%
- Tax name is required (1-255 characters)
- Tax type must be valid enum value
- All inputs validated via Zod schemas

### Access Control

- All endpoints require authentication
- Tenant context required for all operations
- Users can only manage taxes in their tenant

### Soft Deletes

- Taxes are soft-deleted (not permanently removed)
- Deleted taxes can be restored
- Deleted taxes are excluded from normal queries
- Preserves data integrity for historical records

---

## Best Practices

### 1. Tax Naming

Use clear, descriptive names:
- ✅ "GST" or "GST (10%)"
- ✅ "VAT - Standard Rate"
- ✅ "Sales Tax - Ontario"
- ❌ "Tax1" or "Tax A"

### 2. Tax Rate Management

- Keep rates accurate and up-to-date
- Disable taxes instead of deleting when rates change
- Use compound taxes for multi-layer tax structures
- Document tax rate changes

### 3. Tax Status

- Enable/disable taxes based on business needs
- Don't delete taxes that have been used in transactions
- Use soft delete for accidental deletions

### 4. Tax Calculations

- Use model helper methods for consistency
- Round tax amounts appropriately
- Handle edge cases (0% tax, 100% tax)
- Validate calculations in tests

### 5. Performance

- Use active tax filters when possible
- Cache frequently used taxes
- Index queries by tenant_id and is_active

---

## Integration with Other Features

### Transactions

Taxes will be used in the Transactions feature:
- Link taxes to transactions
- Calculate tax amounts automatically
- Track tax by transaction type

### Invoices & Bills

Taxes will be used in future document features:
- Apply taxes to invoice line items
- Calculate total tax for invoices
- Support multiple taxes per document

### Chart of Accounts

Taxes can be linked to accounts:
- Default tax for accounts
- Tax tracking per account
- Tax reporting by account

---

## Troubleshooting

### Common Issues

**Issue: Tax not found**
- Verify tax exists and belongs to tenant
- Check if tax is soft-deleted
- Verify tenant context is set correctly

**Issue: Cannot delete tax**
- Check if tax is used in transactions (future feature)
- Verify tax belongs to tenant
- Use disable instead of delete if tax is in use

**Issue: Tax calculations incorrect**
- Verify tax rate is correct (0-100%)
- Check if using correct tax type
- Ensure base amount is correct
- Use model helper methods for consistency

**Issue: Statistics not accurate**
- Verify tenant context is correct
- Check if filters are applied correctly
- Ensure deleted taxes are excluded

---

## Related Documentation

- [Chart of Accounts](./CHART_OF_ACCOUNTS.md) - Account management
- [Journal Entries](./JOURNAL_ENTRIES.md) - Transaction recording
- [Multi-Tenancy](./MULTI_TENANCY.md) - Tenant isolation
- [API Architecture](./API_ARCHITECTURE.md) - Overall API structure

---

## Summary

The Tax Management feature provides comprehensive tax configuration and management capabilities:

✅ **Complete CRUD Operations** - Create, read, update, delete taxes  
✅ **Status Management** - Enable/disable taxes  
✅ **Statistics & Analytics** - View tax distribution and usage  
✅ **Multiple Tax Types** - Normal, compound, and withholding  
✅ **Tax Calculations** - Built-in helper methods  
✅ **Soft Deletes** - Restore deleted taxes  
✅ **Tenant Isolation** - Secure multi-tenant support  
✅ **Comprehensive API** - 11 endpoints for all operations  

**Next Steps:**
- Integrate taxes with Transactions feature
- Add tax validation in transaction creation
- Implement tax reporting features
- Add tax history tracking

---

**Last Updated:** December 11, 2025  
**Status:** ✅ Complete - Ready for use  
**Version:** 1.0.0

